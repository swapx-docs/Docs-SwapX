# 💰 价格机制与交易安全

## 💰 价格机制与交易安全

SwapX 的价格确定基于自动化做市商（AMM）原理，并在 V2 中通过交易安全措施得到了加强。

### ⚖️ 价格如何确定？ (恒定乘积)

SwapX 上的每个代币对都由一个流动性池（一个持有两种代币余额的智能合约）支持。

* 核心规则： 流动性池强制执行恒定乘积公式（$$ $x \cdot y = k$ $$）。
* 价格动态： 当提款（购买）一种代币时，必须存入（出售）另一种代币的特定比例数量以维持不变量 ($$ $k$ $$)。
* 最终价格： 池中代币当前的比例（比率），结合恒定乘积公式，最终决定了兑换交易的执行价格。

***

### 🔄 SwapX V2 价格处理机制

SwapX V2 将定价的责任从核心合约中移除，从而简化了设计并增强了安全性。

* V1 遗留问题： V1 根据交易指定的是确切输入还是输出，使用两种不同公式之一计算“最佳”执行价格，这增加了概念上的复杂性。
* V2 改进： V2 决定不在核心合约中提供任何定价功能。
  * 相反，V2 交易对仅在每次交易后直接检查不变量（并考虑费用），透明地确保其自身的安全性。
  * 这种设计实现了良好的关注点分离，要求交易必须在外部定价。
* 实施： SwapX 库提供了各种函数来简化这一外部定价过程，路由器的所有兑换功能都基于此设计。

***

### 🛡️ 交易定价与防范抢跑攻击

在进行兑换时，用户希望以固定输入获得最大输出，或以最小输入获得固定输出。然而，仅依赖于简单的储备金比率查询是不安全的。

* 安全风险（抢跑攻击）： 一个仅根据交易对当前储备金比率天真地执行兑换的智能合约容易受到抢跑攻击。恶意行为者可以在该交易确认前立即执行一次小额兑换操纵价格，等待天真交易以不利汇率执行，然后再执行一次兑换将价格调回，从而从受害者的损失中获利。
* 解决方案（滑点与预言机）： 提交兑换交易时，必须事先了解其应执行的\*\*“公允”价格\*\*。
  * 这要求兑换必须确保其在 SwapX 上获得的执行价格，足够接近外部观察（如“预言机”）所认为的“真实”市场价格。
  * 安全机制： 由于套利行为，交易对的区块内储备金比率通常已接近“真实”市场价格。用户提交交易时考虑到这一点，可以极大地限制损失。
  * 前端示例： SwapX 前端就是通过这种方式保障交易安全的。它根据观察到的区块内价格计算最佳输入/输出量，并通过路由器执行兑换，确保兑换汇率不低于用户设定的滑点容忍度（默认为 0.5%）与观察到的区块内汇率的差值。
