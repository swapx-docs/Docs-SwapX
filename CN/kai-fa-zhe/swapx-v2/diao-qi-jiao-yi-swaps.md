# 🔄 掉期交易 (Swaps)

### 🔄 掉期交易 (Swaps)

#### 📝 介绍

SwapX 中的代币交换是一种将一个 ERC-20 代币兑换成另一个 ERC-20 代币的简单方法。

对于最终用户来说，交换是直观的：

1. 用户选择一个输入代币和一个输出代币。
2. 他们指定输入金额，协议计算他们将收到多少输出代币。
3. 然后他们只需单击一下即可执行交换，并立即在钱包中收到输出代币。

在本指南中，我们将研究协议级别的交换过程中发生的情况，以便更深入地了解 SwapX 的工作原理。

**机制：AMM 与订单簿**

SwapX 中的掉期交易与传统平台上的交易不同。SwapX 不使用订单簿来表示流动性或确定价格。SwapX 使用自动做市商 (AMM) 机制来提供有关费率和滑点的即时反馈。

正如我们在协议概述中了解到的，SwapX 上的每对实际上都由一个流动性池支撑。流动性池是智能合约，它持有两种独特代币的余额，并执行有关存款和取款的规则。

该规则是常数乘积公式（$$ $x \times y = k$ $$）。当提取（购买）任一代币时，必须存入（出售）一定比例的另一个代币，以保持常数。

***

#### 🔬 掉期交易的构成

从最基本的层面上讲，SwapX V2 中的所有交换都发生在一个函数中，该函数恰如其名 `swap`：

Solidity

```
function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data);
```

**接收代币**

从函数签名中可以清楚地看出，SwapX 要求 `swap` 调用者通过 `amount0Out` 和 `amount1Out` 参数指定他们希望接收多少个输出代币，这些参数对应于所需的 `token0` 和 `token1` 数量。

**发送代币（付款）**

目前尚不清楚的是 SwapX 如何接收代币作为交换的付款。

通常，需要代币来执行某些功能的智能合约要求调用者首先在代币合约上进行 `approve`（批准），然后调用一个函数，该函数反过来在代币合约上调用 `transferFrom`。

这不是 V2 交易对接受代币的方式。

相反，交易对在每次交互结束时检查其代币余额。然后，在下一次交互开始时，将当前余额与存储的值进行比较，以确定当前交互者发送的代币数量。

> 核心要点：
>
> 在调用 `swap` 之前，代币必须被转移到交易对中。（此规则的一个例外是 [闪电贷](https://www.google.com/search?q=insert-link-to-flash-swap-docs-if-available\&authuser=3)）。
>
> 这意味着要安全地使用 `swap` 函数，它必须从另一个智能合约中调用。替代方法（将代币转移到交易对中然后调用 `swap`）在非原子情况下是不安全的，因为发送的代币容易受到即时套利。
