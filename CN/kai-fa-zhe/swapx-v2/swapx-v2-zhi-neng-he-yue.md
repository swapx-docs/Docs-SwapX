# ⚙️ SwapX V2 智能合约

## ⚙️ SwapX V2 智能合约

SwapX V2 是一个**二元智能合约系统**。核心合约 (Core) 为与 SwapX 交互的各方提供基本的安全保障，而外围合约 (Periphery) 则用于方便用户交互。

### 🧠 核心 (Core)

核心 (Core) 采用极简，甚至是\*\*“野蛮”\*\*的设计理念。这样做的原因是：

* 表面积较小的合约更容易推导 (reasoning)，不易出错，且功能更优雅。
* 系统所需的许多属性可以直接在代码中声明，几乎没有出错的余地。

> **⚠️ 注意：** 核心合约在使用上对用户不够友好。在大多数情况下，**不建议**直接与这些合约交互。应转而使用外围合约 (Periphery)。

#### Factory

`Factory` 是一个**单例**合约，其职责包括：

* 保存为配对提供支持的通用字节码。
* 为每个唯一的代币配对创建且仅创建一个智能合约，并对其进行索引。
* 包含启动协议收费的逻辑。

#### Pairs

`Pair` (配对) 合约主要有三个目的：

1. **自动做市商 (AMM):** 充当交易执行的场所。
2. **池代币余额追踪:** 跟踪池代币的余额。
3. **价格预言机数据:** 公开可用于构建去中心化价格预言机的数据。

### 📦 外围 (Periphery)

外围 (Periphery) 是一组智能合约，旨在支持与核心进行**特定领域的交互**。由于 SwapX 的无权限性质，下述合约只是可能的外围类合约的一小部分，但它们是安全有效地与 SwapX V2 交互的有用示例。

#### Library

`Library` (库) 提供了多种便捷函数，用于**获取数据和定价**。

#### Router

`Router` (路由器) 使用 `Library`，完全支持前端提供交易和流动性管理功能的所有基本要求。

* **原生支持**多对交易（例如 `Token X` 到 `Y` 到 `Z`）。
* 提供用于**消除流动性 (liquidity removal) 的元交易**。

### 💡 设计决策 (Design Decisions)

以下部分描述了 SwapX V2 中做出的一些值得注意的设计决策。除非你有兴趣深入了解 V2 的底层工作原理，或正在编写智能合约集成，否则可以放心跳过这些内容！

#### 代币发送 (Sending Tokens)

V2 接受代币的方式不同于传统的 `approve`/`transferFrom` 模式：

* 配对会在每次交互**结束时**检查其代币余额。
* 在下一次交互**开始时**，通过当前余额与存储值之差来确定当前交互者发送的代币数量。
* **关键点：** 在调用任何需要代币的方法之前，**必须先将代币转移到该配对**。（有关原因，请参阅白皮书。）

#### WXOC

与 SwapX V1 池不同，V2 配对不直接支持 **ETH**。因此，必须使用 **WXOC**（Wrapped XOC）来模拟 `ETH⇄ERC-20` 配对。

* **动机:** 旨在删除核心中特定于 XOC 的代码，从而获得更干净的代码库。
* **用户体验:** 最终用户可以完全不了解此实现细节，只需在外围包装/解包 XOC 即可。
* **路由器支持:** 路由器完全支持通过 XOC 与任何 WXOC 配对进行交互。

#### 最小流动性 (Minimum Liquidity)

为改善舍入误差并增加流动性供应的理论最小报价单位，交易对会**销毁**第一个 `MINIMUM_LIQUIDITY` 池代币。

* 对于绝大多数交易对来说，这将代表一个**微不足道**的值。
* 销毁会在**第一次流动性供应**期间自动发生，此后总供应量将永远受到限制。
